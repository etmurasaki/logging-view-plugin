/* eslint-disable max-len */
import { csvFromQueryResponse, escapeCSVValue } from '../download-csv';
import { QueryRangeResponse } from '../logs.types';

describe('download CSV', () => {
  it('should escape data correctly', () => {
    [
      { data: '', escapedData: '' },
      { data: 'test', escapedData: 'test' },
      { data: 'test,test', escapedData: `"test,test"` },
      { data: 'test\ntest', escapedData: `"test\\ntest"` },
      { data: 'test\rtest', escapedData: `"test\\rtest"` },
      { data: 'test"test"', escapedData: `"test""test"""` },
      { data: '{"test": "test"}', escapedData: `"{""test"": ""test""}"` },
      {
        data: `{"count":0,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"warn","msg":"OS not found try installing one","stream":"stdout","ts":"2025-01-29T07:23:52.6392194{"coun{"count":1,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"failed to reach the cloud, try again on a rainy day","stream":"s{"count":2,"host":"2a1b688652c6.0.000000000000{"count":2,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"failing to cook potatoes","stream":"stdout","ts"{"co{"count":3,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"error","msg":"failing to cook potatoes","stream":"stdout","ts":"2025-01-29T07:23:52.657082657{"co{"count":4,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"random error happened during compression","stream":"stdout","ts":"2025-01-29T07:23:52.657454906Z"}`,
        escapedData: `"{""count"":0,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""warn"",""msg"":""OS not found try installing one"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.6392194{""coun{""count"":1,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""failed to reach the cloud, try again on a rainy day"",""stream"":""s{""count"":2,""host"":""2a1b688652c6.0.000000000000{""count"":2,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts""{""co{""count"":3,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""error"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.657082657{""co{""count"":4,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""random error happened during compression"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.657454906Z""}"`,
      },
    ].forEach(({ data, escapedData }) => {
      expect(escapeCSVValue(data)).toEqual(escapedData);
    });
  });

  it('should generate a CSV string from a query response', () => {
    [
      { response: undefined, csv: '' },
      {
        response: {
          status: 'success',
          data: {
            resultType: 'streams',
            result: [],
            stats: {},
          },
        },
        csv: 'time,raw\n',
      },
      {
        response: {
          status: 'success',
          data: {
            resultType: 'streams',
            result: [
              {
                stream: {
                  __stream_shard__: '0',
                  detected_level: 'debug',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  kubernetes_container_name: 'test-container',
                  kubernetes_namespace_name: 'log-test',
                  kubernetes_pod_name: 'alertmanager-main-0',
                  level: 'debug',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451007073',
                    '{"count":0,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"warn","msg":"OS not found try installing one","stream":"stdout","ts":"2025-01-29T07:23:52.6392194{"coun{"count":1,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"failed to reach the cloud, try again on a rainy day","stream":"s{"count":2,"host":"2a1b688652c6.0.000000000000{"count":2,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"failing to cook potatoes","stream":"stdout","ts"{"co{"count":3,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"error","msg":"failing to cook potatoes","stream":"stdout","ts":"2025-01-29T07:23:52.657082657{"co{"count":4,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"random error happened during compression","stream":"stdout","ts":"2025-01-29T07:23:52.657454906Z"}',
                  ],
                  [
                    '1738135437451367780',
                    '{"count":26,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"panic: this should never happen","stream":"stdout","ts":"2025-01-29T07:23:52.665923866Z"}',
                  ],
                  [
                    '1738135437451541696',
                    '{"count":43,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"change stuff and see what happens","stream":"stderr","{"count":43,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"we got here","stream":"stdout","ts":"2025-01-29T07:23:52.670960425Z"}',
                  ],
                  [
                    '1738135437451808820',
                    '{"count":81,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"random error happened during compression","stream":"stdout","ts":"2025-01-29T07:23:52.682014789Z"}',
                  ],
                  [
                    '1738135437451918361',
                    '{"count":93,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"we got here","stream":"stdout","ts":"2025-01-29T07:23:52.687848304Z"}',
                  ],
                ],
              },
              {
                stream: {
                  __stream_shard__: '0',
                  detected_level: 'error',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  level: 'error',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451158823',
                    '{"count":12,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"failed to reach the cloud, try again on a rainy day","stream":"stdout","ts":"2025-01-29T07:23:52.659924811Z"}',
                  ],
                  [
                    '1738135437451460446',
                    '{"count":40,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"error","msg":"OS not found try installing one","stream":"stdout","ts":"2025-01-29T07:23:52.67087705Z"}',
                  ],
                  [
                    '1738135437451652695',
                    '{"count":59,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"Don’t use beef stew as a computer password. It’s not stroganoff.","stream":"stderr","ts":"2025-01-29T07:23:52.676431941Z"}',
                  ],
                  [
                    '1738135437451770986',
                    '{"count":75,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"cannot over-write a locked variable.","stream":"stdout","ts":"2025-01-29T07:23:52.680780295Z"}',
                  ],
                  [
                    '1738135437451873278',
                    '{"count":87,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"too many foobar variable","stream":"stdout","ts":"2025-01-29T07:23:52.683604824Z"}',
                  ],
                  [
                    '1738135437452004277',
                    '{"count":105,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"panic: could not read the manual","stream":"stdout","ts":"2025-01-29T07:23:52.689656545Z"}',
                  ],
                ],
              },
              {
                stream: {
                  __stream_shard__: '0',
                  detected_level: 'info',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  kubernetes_container_name: 'test-container',
                  kubernetes_namespace_name: 'log-test',
                  kubernetes_pod_name: 'alertmanager-main-0',
                  level: 'info',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451024907',
                    '{"count":8,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"too many foobar variable","stream":"stdout","ts":"2025-01-29T07:23:52.658278193Z"}',
                  ],
                  [
                    '1738135437451408155',
                    '{"count":32,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"change stuff and see what happens","stream":"stdout","ts":"2025-01-29T07:23:52.668567311Z"}',
                  ],
                  [
                    '1738135437451603404',
                    '{"count":52,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"info","msg":"You\'re screwed !","stream":"stderr","ts":"2025-01-29T07:23:52.674248576Z"}',
                  ],
                  [
                    '1738135437451704903',
                    '{"count":67,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"info","msg":"failing to cook potatoes","stream":"stdout","ts":"2025-01-29T07:23:52.678705388Z"}',
                  ],
                  [
                    '1738135437451897777',
                    '{"count":92,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"info","msg":"a chicken died during processing","stream":"stdout","ts":"2025-01-29T07:23:52.687554347Z"}',
                  ],
                ],
              },
              {
                stream: {
                  __stream_shard__: '0',
                  detected_level: 'warn',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  kubernetes_container_name: 'test-container',
                  kubernetes_namespace_name: 'log-test',
                  kubernetes_pod_name: 'alertmanager-main-0',
                  level: 'warn',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451015365',
                    '{"count":5,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"failed to reach the cloud, try again on a rainy day","stream":"stdout","ts":"2025-01-29T07:23:52.{"count":6,"{"count":6,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"warn","msg":"change stuff and see what happens","stream":"stdout","ts":"2025-01-29T07:23:52.657892404Z"}',
                  ],
                  [
                    '1738135437451448530',
                    '{"count":35,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"failed to reach the cloud, try again on a rainy day","stream":"stdout","ts":"2025-01{"count":35,"host":"2a1b68{"count":36,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"foo insists on strongly-typed programming languages","stream":"stdout"{"count":36,"host":"2a1b688652c6.1.00000{"count":37,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"failed to reach the cloud, try again on a {"count":37,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200"{"count":38,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"info","msg":"failed to get an error {"count":38,"host":"2a1b688652c6.1.00000000000000007A44C9E5C626420{"count":39,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"warn","msg":"a chicken died during processing","stream":"stdout","ts":"2025-01-29T07:23:52.670204387Z"}',
                  ],
                  [
                    '1738135437451751070',
                    '{"count":73,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"warn","msg":"You\'re screwed !","stream":"stderr","ts":"2025-01-29T07:23:52.680401214Z"}',
                  ],
                  [
                    '1738135437452014860',
                    '{"count":106,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"warn","msg":"too many foobar variable","stream":"stderr","ts":"2025-01-29T07:23:52.689728295Z"}',
                  ],
                  [
                    '1738135437452078027',
                    '{"count":113,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"warn","msg":"random error happened during compression","stream":"stdout","ts":"2025-01-29T07:23:52.691656119Z"}',
                  ],
                ],
              },
              {
                stream: {
                  __stream_shard__: '1',
                  detected_level: 'debug',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  kubernetes_container_name: 'test-container',
                  kubernetes_namespace_name: 'log-test',
                  kubernetes_pod_name: 'alertmanager-main-0',
                  level: 'debug',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451021448',
                    '{"count":7,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"foo insists on strongly-typed programming languages","stream":"stdout","ts":"2025-01-29T07:23:52.658075403Z"}',
                  ],
                  [
                    '1738135437451383488',
                    '{"count":30,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"debug","msg":"John Doe solved the Travelling Salesman problem in O(1) time. Here\'s the pseudo-code: Break salesman into N pieces. Kick each piece to a different city.","stream":"stdout","ts":"2025-01-29T07:23:52.667301776Z"}',
                  ],
                  [
                    '1738135437451670487',
                    '{"count":62,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"Stupidity made this error, not me","stream":"stderr","ts":"2025-01-29T07:23:52.676693481Z"}',
                  ],
                  [
                    '1738135437451811528',
                    '{"count":82,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"sorry the server is not in a mood","stream":"stdout","ts":"2025-01-29T07:23:52.682219413Z"}',
                  ],
                  [
                    '1738135437451919611',
                    '{"count":94,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"debug","msg":"I used stack overflow to fix this bug","stream":"stderr","ts":"2025-01-29T07:23:52.687908178Z"}',
                  ],
                ],
              },
              {
                stream: {
                  __stream_shard__: '1',
                  detected_level: 'error',
                  filename: '/var/log/generated.log',
                  job: 'varlogs-duplicate',
                  kubernetes_container_name: 'test-container',
                  kubernetes_namespace_name: 'log-test',
                  kubernetes_pod_name: 'alertmanager-main-0',
                  level: 'error',
                  log_type: 'application',
                  service_name: 'varlogs-duplicate',
                },
                values: [
                  [
                    '1738135437451201572',
                    '{"count":14,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"John Doe solved the Travelling Salesman problem in O(1) time. Here\'s the pseudo-code: Break salesman into N pieces. Kick each piece to a different city.","stream":"stdout","ts":"2025-01-29T07:23:52.661480887Z"}',
                  ],
                  [
                    '1738135437451592237',
                    '{"count":46,"host":"2a1b688652c6.0.00000000000000004D08FC57CDAD6659","lvl":"error","msg":"a chicken died dur{"count":46,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"failing to cook potatoes","stream":"stdout","ts":"2025-01-29T07:23:52.671905379Z"}',
                  ],
                  [
                    '1738135437451691695',
                    '{"count":65,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"Stupidity made this error, not me","stream":"stderr","ts":"2025-01-29T07:23:52.678208182Z"}',
                  ],
                  [
                    '1738135437451773903',
                    '{"count":76,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"try googling this error message if it appears again","stream":"stderr","ts":"2025-01-29T07:23:52.680970461Z"}',
                  ],
                  [
                    '1738135437451930361',
                    '{"count":97,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"try googling this error message if it appears again","stream":"stdout","ts":"2025-01-29T07:23:52.688500259Z"}',
                  ],
                  [
                    '1738135437452071985',
                    '{"count":111,"host":"2a1b688652c6.1.00000000000000007A44C9E5C6264200","lvl":"error","msg":"we got here","stream":"stderr","ts":"2025-01-29T07:23:52.690896956Z"}',
                  ],
                ],
              },
            ],
            stats: {},
          },
        },
        csv: `time,__stream_shard__,detected_level,filename,job,kubernetes_container_name,kubernetes_namespace_name,kubernetes_pod_name,level,log_type,service_name,raw
1738135437451007073,0,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":0,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""warn"",""msg"":""OS not found try installing one"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.6392194{""coun{""count"":1,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""failed to reach the cloud, try again on a rainy day"",""stream"":""s{""count"":2,""host"":""2a1b688652c6.0.000000000000{""count"":2,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts""{""co{""count"":3,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""error"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.657082657{""co{""count"":4,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""random error happened during compression"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.657454906Z""}",
1738135437451367780,0,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":26,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""panic: this should never happen"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.665923866Z""}",
1738135437451541696,0,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":43,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""change stuff and see what happens"",""stream"":""stderr"",""{""count"":43,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""we got here"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.670960425Z""}",
1738135437451808820,0,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":81,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""random error happened during compression"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.682014789Z""}",
1738135437451918361,0,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":93,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""we got here"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.687848304Z""}",
1738135437451158823,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":12,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""failed to reach the cloud, try again on a rainy day"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.659924811Z""}",
1738135437451460446,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":40,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""error"",""msg"":""OS not found try installing one"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.67087705Z""}",
1738135437451652695,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":59,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""Don’t use beef stew as a computer password. It’s not stroganoff."",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.676431941Z""}",
1738135437451770986,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":75,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""cannot over-write a locked variable."",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.680780295Z""}",
1738135437451873278,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":87,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""too many foobar variable"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.683604824Z""}",
1738135437452004277,0,error,/var/log/generated.log,varlogs-duplicate,,,,error,application,varlogs-duplicate,"{""count"":105,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""panic: could not read the manual"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.689656545Z""}",
1738135437451024907,0,info,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,info,application,varlogs-duplicate,"{""count"":8,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""too many foobar variable"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.658278193Z""}",
1738135437451408155,0,info,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,info,application,varlogs-duplicate,"{""count"":32,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""change stuff and see what happens"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.668567311Z""}",
1738135437451603404,0,info,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,info,application,varlogs-duplicate,"{""count"":52,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""info"",""msg"":""You're screwed !"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.674248576Z""}",
1738135437451704903,0,info,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,info,application,varlogs-duplicate,"{""count"":67,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""info"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.678705388Z""}",
1738135437451897777,0,info,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,info,application,varlogs-duplicate,"{""count"":92,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""info"",""msg"":""a chicken died during processing"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.687554347Z""}",
1738135437451015365,0,warn,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,warn,application,varlogs-duplicate,"{""count"":5,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""failed to reach the cloud, try again on a rainy day"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.{""count"":6,""{""count"":6,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""warn"",""msg"":""change stuff and see what happens"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.657892404Z""}",
1738135437451448530,0,warn,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,warn,application,varlogs-duplicate,"{""count"":35,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""failed to reach the cloud, try again on a rainy day"",""stream"":""stdout"",""ts"":""2025-01{""count"":35,""host"":""2a1b68{""count"":36,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""foo insists on strongly-typed programming languages"",""stream"":""stdout""{""count"":36,""host"":""2a1b688652c6.1.00000{""count"":37,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""failed to reach the cloud, try again on a {""count"":37,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200""{""count"":38,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""info"",""msg"":""failed to get an error {""count"":38,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C626420{""count"":39,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""warn"",""msg"":""a chicken died during processing"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.670204387Z""}",
1738135437451751070,0,warn,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,warn,application,varlogs-duplicate,"{""count"":73,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""warn"",""msg"":""You're screwed !"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.680401214Z""}",
1738135437452014860,0,warn,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,warn,application,varlogs-duplicate,"{""count"":106,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""warn"",""msg"":""too many foobar variable"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.689728295Z""}",
1738135437452078027,0,warn,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,warn,application,varlogs-duplicate,"{""count"":113,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""warn"",""msg"":""random error happened during compression"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.691656119Z""}",
1738135437451021448,1,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":7,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""foo insists on strongly-typed programming languages"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.658075403Z""}",
1738135437451383488,1,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":30,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""debug"",""msg"":""John Doe solved the Travelling Salesman problem in O(1) time. Here's the pseudo-code: Break salesman into N pieces. Kick each piece to a different city."",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.667301776Z""}",
1738135437451670487,1,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":62,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""Stupidity made this error, not me"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.676693481Z""}",
1738135437451811528,1,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":82,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""sorry the server is not in a mood"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.682219413Z""}",
1738135437451919611,1,debug,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,debug,application,varlogs-duplicate,"{""count"":94,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""debug"",""msg"":""I used stack overflow to fix this bug"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.687908178Z""}",
1738135437451201572,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":14,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""John Doe solved the Travelling Salesman problem in O(1) time. Here's the pseudo-code: Break salesman into N pieces. Kick each piece to a different city."",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.661480887Z""}",
1738135437451592237,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":46,""host"":""2a1b688652c6.0.00000000000000004D08FC57CDAD6659"",""lvl"":""error"",""msg"":""a chicken died dur{""count"":46,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""failing to cook potatoes"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.671905379Z""}",
1738135437451691695,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":65,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""Stupidity made this error, not me"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.678208182Z""}",
1738135437451773903,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":76,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""try googling this error message if it appears again"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.680970461Z""}",
1738135437451930361,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":97,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""try googling this error message if it appears again"",""stream"":""stdout"",""ts"":""2025-01-29T07:23:52.688500259Z""}",
1738135437452071985,1,error,/var/log/generated.log,varlogs-duplicate,test-container,log-test,alertmanager-main-0,error,application,varlogs-duplicate,"{""count"":111,""host"":""2a1b688652c6.1.00000000000000007A44C9E5C6264200"",""lvl"":""error"",""msg"":""we got here"",""stream"":""stderr"",""ts"":""2025-01-29T07:23:52.690896956Z""}",
`,
      },
      {
        response: {
          status: 'success',
          data: {
            resultType: 'matrix',
            result: [
              {
                metric: {
                  level: 'debug',
                },
                values: [
                  [1738135448, '21.773333333333333'],
                  [1738135462, '44.26166666666666'],
                  [1738135476, '64.80166666666666'],
                  [1738135490, '85.26666666666667'],
                  [1738135504, '102.75833333333333'],
                  [1738135518, '123.96666666666667'],
                  [1738135532, '146.11333333333334'],
                  [1738135546, '166.78166666666667'],
                  [1738135560, '185.785'],
                  [1738135574, '208.475'],
                  [1738135588, '231.615'],
                  [1738135602, '252.45499999999998'],
                  [1738135616, '277.09333333333336'],
                  [1738135630, '298.5716666666667'],
                  [1738135644, '321.83833333333337'],
                  [1738135658, '342.43333333333334'],
                  [1738135672, '363.60833333333335'],
                  [1738135686, '384.29833333333335'],
                  [1738135700, '404.02500000000003'],
                  [1738139046, '887.13'],
                  [1738139060, '869.1133333333333'],
                ],
              },
              {
                metric: {
                  level: 'error',
                },
                values: [
                  [1738135448, '22.401666666666667'],
                  [1738135462, '44.913333333333334'],
                  [1738135476, '65.785'],
                  [1738135490, '86.05833333333334'],
                  [1738135504, '103.32000000000001'],
                  [1738135518, '124.62333333333333'],
                  [1738135532, '146.75'],
                  [1738135546, '167.58166666666665'],
                  [1738135560, '186.98499999999999'],
                  [1738135574, '209.79333333333332'],
                  [1738135588, '232.9283333333333'],
                  [1738135602, '253.71166666666667'],
                  [1738135616, '279.015'],
                  [1738135630, '299.89666666666665'],
                  [1738139032, '885.9033333333333'],
                  [1738139046, '887.0833333333334'],
                  [1738139060, '869.1883333333334'],
                ],
              },
              {
                metric: {
                  level: 'info',
                },
                values: [
                  [1738135448, '21.95'],
                  [1738135462, '44.39666666666667'],
                  [1738135476, '65.34333333333333'],
                  [1738135490, '85.59333333333333'],
                  [1738135504, '103.05166666666668'],
                  [1738135518, '124.715'],
                  [1738135532, '147.26500000000001'],
                  [1738135546, '167.97666666666666'],
                  [1738135560, '187.05833333333334'],
                  [1738135574, '209.63'],
                  [1738135588, '232.41333333333333'],
                  [1738135602, '253.12'],
                  [1738135616, '278.185'],
                  [1738135630, '299.195'],
                ],
              },
              {
                metric: {
                  level: 'warn',
                },
                values: [
                  [1738135448, '21.82'],
                  [1738135462, '43.97'],
                  [1738138304, '852.77'],
                  [1738138318, '853.7283333333334'],
                  [1738138332, '853.8283333333334'],
                  [1738138346, '851.37'],
                  [1738138360, '851.2816666666666'],
                  [1738138374, '850.6483333333333'],
                  [1738138388, '849.18'],
                  [1738138402, '849.515'],
                  [1738138962, '877.8683333333333'],
                  [1738138976, '881.4366666666666'],
                  [1738138990, '882.1216666666667'],
                  [1738139004, '882.8416666666667'],
                  [1738139018, '883.0116666666667'],
                  [1738139032, '883.9716666666667'],
                  [1738139046, '884.67'],
                  [1738139060, '868.08'],
                ],
              },
              {
                metric: {},
                values: [
                  [1738135448, '0.041666666666666664'],
                  [1738135462, '0.041666666666666664'],
                  [1738135476, '0.041666666666666664'],
                  [1738135490, '0.041666666666666664'],
                  [1738135504, '0.041666666666666664'],
                  [1738135518, '0.041666666666666664'],
                  [1738135532, '0.041666666666666664'],
                  [1738135546, '0.041666666666666664'],
                  [1738135560, '0.041666666666666664'],
                  [1738135574, '0.041666666666666664'],
                  [1738135588, '0.041666666666666664'],
                  [1738136036, '0.041666666666666664'],
                ],
              },
            ],
            stats: {},
          },
        },
        csv: `time,y,level
1738135448,21.773333333333333,debug,
1738135462,44.26166666666666,debug,
1738135476,64.80166666666666,debug,
1738135490,85.26666666666667,debug,
1738135504,102.75833333333333,debug,
1738135518,123.96666666666667,debug,
1738135532,146.11333333333334,debug,
1738135546,166.78166666666667,debug,
1738135560,185.785,debug,
1738135574,208.475,debug,
1738135588,231.615,debug,
1738135602,252.45499999999998,debug,
1738135616,277.09333333333336,debug,
1738135630,298.5716666666667,debug,
1738135644,321.83833333333337,debug,
1738135658,342.43333333333334,debug,
1738135672,363.60833333333335,debug,
1738135686,384.29833333333335,debug,
1738135700,404.02500000000003,debug,
1738139046,887.13,debug,
1738139060,869.1133333333333,debug,
1738135448,22.401666666666667,error,
1738135462,44.913333333333334,error,
1738135476,65.785,error,
1738135490,86.05833333333334,error,
1738135504,103.32000000000001,error,
1738135518,124.62333333333333,error,
1738135532,146.75,error,
1738135546,167.58166666666665,error,
1738135560,186.98499999999999,error,
1738135574,209.79333333333332,error,
1738135588,232.9283333333333,error,
1738135602,253.71166666666667,error,
1738135616,279.015,error,
1738135630,299.89666666666665,error,
1738139032,885.9033333333333,error,
1738139046,887.0833333333334,error,
1738139060,869.1883333333334,error,
1738135448,21.95,info,
1738135462,44.39666666666667,info,
1738135476,65.34333333333333,info,
1738135490,85.59333333333333,info,
1738135504,103.05166666666668,info,
1738135518,124.715,info,
1738135532,147.26500000000001,info,
1738135546,167.97666666666666,info,
1738135560,187.05833333333334,info,
1738135574,209.63,info,
1738135588,232.41333333333333,info,
1738135602,253.12,info,
1738135616,278.185,info,
1738135630,299.195,info,
1738135448,21.82,warn,
1738135462,43.97,warn,
1738138304,852.77,warn,
1738138318,853.7283333333334,warn,
1738138332,853.8283333333334,warn,
1738138346,851.37,warn,
1738138360,851.2816666666666,warn,
1738138374,850.6483333333333,warn,
1738138388,849.18,warn,
1738138402,849.515,warn,
1738138962,877.8683333333333,warn,
1738138976,881.4366666666666,warn,
1738138990,882.1216666666667,warn,
1738139004,882.8416666666667,warn,
1738139018,883.0116666666667,warn,
1738139032,883.9716666666667,warn,
1738139046,884.67,warn,
1738139060,868.08,warn,
1738135448,0.041666666666666664,,
1738135462,0.041666666666666664,,
1738135476,0.041666666666666664,,
1738135490,0.041666666666666664,,
1738135504,0.041666666666666664,,
1738135518,0.041666666666666664,,
1738135532,0.041666666666666664,,
1738135546,0.041666666666666664,,
1738135560,0.041666666666666664,,
1738135574,0.041666666666666664,,
1738135588,0.041666666666666664,,
1738136036,0.041666666666666664,,
`,
      },
    ].forEach(({ response, csv }) => {
      expect(csvFromQueryResponse(response as QueryRangeResponse)).toEqual(csv);
    });
  });
});
